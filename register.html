<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Artisan Verification Form</title>

    <style>
      /* === Aesthetic White Theme === */

      /* --- CSS Variables (Theme) --- */
      :root {
        /* A clean, minimalist light palette */
        --background: 210 40% 98%; /* Soft, cool off-white background */
        --foreground: 220 15% 20%; /* Dark charcoal for text */
        --card: 0 0% 100%; /* Pure white for cards */
        --primary: 220 15% 20%; /* Dark charcoal as the primary accent */
        --primary-foreground: 0 0% 100%; /* White text for buttons */
        --muted-foreground: 220 10% 45%; /* Medium gray for secondary text */
        --border: 214 32% 91%; /* Light, subtle border */
        --input: 214 32% 91%;
        --ring: 220 15% 30%; /* A slightly lighter charcoal for focus rings */
        --radius: 0.5rem;
      }

      /* --- Basic Reset and Body Styles --- */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background-color: hsl(var(--background));
        color: hsl(var(--foreground));
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* --- Layout Styles --- */
      .container {
        max-width: 42rem; /* 672px */
        margin: 0 auto;
        padding: 1.5rem 1rem;
      }

      header {
        text-align: center;
        margin-bottom: 2.5rem;
      }

      header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: hsl(var(--foreground)); /* Use main text color for the title */
      }

      header p {
        color: hsl(var(--muted-foreground));
        margin-top: 0.5rem;
        font-size: 1.1rem;
      }

      /* --- Form Styles --- */
      .artisan-form {
        background-color: hsl(var(--card));
        padding: 1.5rem;
        border-radius: var(--radius);
        border: 1px solid hsl(var(--border));
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05),
          0 2px 4px -2px rgba(0, 0, 0, 0.05);
      }

      /* Adds vertical space between direct children of the form */
      .artisan-form > * + * {
        margin-top: 1.5rem;
      }

      /* --- Form Element Styles --- */
      label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
      }

      .form-input {
        width: 100%;
        padding: 0.75rem;
        background-color: hsl(var(--background));
        border: 1px solid hsl(var(--input));
        border-radius: calc(var(--radius) - 2px);
        font-size: 1rem;
        color: hsl(var(--foreground));
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: hsl(var(--ring));
        box-shadow: 0 0 0 2px hsla(var(--ring), 0.5);
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .form-file-input {
        width: 100%;
        font-size: 0.875rem;
        color: hsl(var(--muted-foreground));
      }

      .form-file-input::file-selector-button {
        margin-right: 1rem;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: calc(var(--radius) - 2px);
        font-size: 0.875rem;
        font-weight: 600;
        background-color: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .form-file-input::file-selector-button:hover {
        opacity: 0.9;
      }

      .submit-btn {
        width: 100%;
        background-color: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
        font-weight: 700;
        font-size: 1rem;
        padding: 0.75rem 1rem;
        border-radius: calc(var(--radius) - 2px);
        border: none;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .submit-btn:hover {
        opacity: 0.9;
      }

      .submit-btn:focus {
        outline: none;
        box-shadow: 0 0 0 2px hsl(var(--background)), 0 0 0 4px hsl(var(--ring));
      }

      .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* --- Message Box & Footer --- */
      .message-box {
        text-align: center;
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: calc(var(--radius) - 2px);
        display: none; /* Initially hidden */
      }
      .message-box.show {
        display: block;
      }
      .message-box.success {
        background-color: #d1fae5; /* A light green */
        color: #065f46; /* A dark green */
      }
      .message-box.error {
        background-color: #fee2e2; /* A light red */
        color: #991b1b; /* A dark red */
      }

      footer {
        text-align: center;
        margin-top: 2.5rem;
      }

      footer a {
        font-size: 0.875rem;
        color: hsl(var(--muted-foreground));
        text-decoration: none;
        transition: color 0.2s;
      }

      footer a:hover {
        color: hsl(var(--foreground));
        text-decoration: underline;
      }
      .top-right-link {
        /* This is the key part for positioning */
        position: fixed;
        bottom: 20px; /* 20px from the top */
        right: 20px; /* 20px from the right */

        /* The z-index ensures it's on top of other content */
        z-index: 1000;

        /* --- Optional styling to make it look nice --- */
        padding: 0.6rem 1rem;
        background-color: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
        text-decoration: none;
        font-family: sans-serif;
        font-size: 0.9rem;
        border-radius: 5px;
        transition: background-color 0.2s ease-in-out;
      }

      .top-right-link:hover {
        background-color: #555;
      }

      /* --- Mobile Responsive Styles --- */
      @media (min-width: 768px) {
        .container {
          padding: 3rem 2rem;
        }

        header h1 {
          font-size: 2.25rem;
        }

        .artisan-form {
          padding: 2.5rem;
        }

        .form-grid {
          grid-template-columns: 1fr 1fr;
        }
        
      }
    </style>
  </head>
  <body>
    <a href="admin.html" class="top-right-link">Admin Dashboard</a>
    <div class="container">
      <header>
        <h1>Artisan Verification</h1>
        <p>Submit your details and craft for verification.</p>
      </header>

      <form id="artisanForm" class="artisan-form">
        <div>
          <label for="name">Full Name</label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="form-input"
          />
        </div>
        <div>
          <label for="phone">Phone Number</label>
          <input
            type="tel"
            id="phone"
            name="phone"
            required
            class="form-input"
          />
        </div>
        <div>
          <label for="craft">Craft</label>
          <input
            type="text"
            id="craft"
            name="craft"
            required
            class="form-input"
          />
        </div>
        <div>
          <label for="awards">Awards</label>
          <input
            type="text"
            id="awards"
            name="awards"
            placeholder="e.g., National Award, State Award"
            class="form-input"
          />
        </div>
        <div>
          <label for="one_liner">One Liner</label>
          <input
            type="text"
            id="one_liner"
            name="one_liner"
            placeholder="A short tagline about the artisan"
            class="form-input"
          />
        </div>
        <div>
          <label for="quote">Quote</label>
          <input
            type="text"
            id="quote"
            name="quote"
            placeholder="Inspiring quote by the artisan"
            class="form-input"
          />
        </div>

        <!-- Craft Process -->
        <div>
          <label for="craft_process">Craft Process</label>
          <textarea
            id="craft_process"
            name="craft_process"
            placeholder="Describe the craft making process"
            class="form-input"
          ></textarea>
        </div>

        <!-- GI Tag Info -->
        <div>
          <label for="g_tag_info">GI Tag Info</label>
          <input
            type="text"
            id="g_tag_info"
            name="gi_tag_info"
            placeholder="GI Tag details if applicable"
            class="form-input"
          />
        </div>

        <!-- Verification Notes (optional, admin use) -->
        <div>
          <label for="verification_notes">Verification Notes</label>
          <textarea
            id="verification_notes"
            name="verification_notes"
            placeholder="Admin verification notes"
            class="form-input"
          ></textarea>
        </div>

        <!-- Photo Link -->
        <div>
          <label for="photo_link">Upload Artisan Photo</label>
          <input
            type="file"
            id="photo_link"
            name="photo_link"
            accept="image/*"
            class="form-input"
          />
        </div>

        <!-- Workshop Photo Link -->
        <div>
          <label for="workshop_photo_link">Workshop Photo Link</label>
          <input
            type="file"
            id="workshop_photo_link"
            name="workshop_photo_link"
            accept="image/*"
            class="form-input"
            multiple
          />
        </div>

        <!-- Video Link -->
        <div>
          <label for="video_link">Video Link</label>
          <input
            type="url"
            id="video_link"
            name="video_link"
            placeholder="Paste YouTube or Vimeo link"
            class="form-input"
          />
        </div>

        <!-- Business Identity -->
        <div>
          <label for="business_identity"
            >Business Identity (Established Year)</label
          >
          <input
            type="text"
            id="business_identity"
            name="business_identity"
            placeholder="Business identity details"
            class="form-input"
          />
        </div>

        <div>
          <label for="aadhaar_last4">Last 4 Digits of Aadhaar</label>
          <input
            type="text"
            id="aadhaar_last4"
            name="aadhaar_last4"
            required
            minlength="4"
            maxlength="4"
            pattern="\d{4}"
            class="form-input"
          />
        </div>
        <div>
          <label for="location">Location (City, State)</label>
          <input
            type="text"
            id="location"
            name="location"
            required
            class="form-input"
          />
        </div>

        <div class="form-grid">
          <div>
            <label for="aadhaar_front">Aadhaar Card (Front)</label>
            <input
              type="file"
              id="aadhaar_front"
              name="aadhaar_front"
              required
              accept="image/*"
              class="form-file-input"
            />
          </div>
          <div>
            <label for="aadhaar_back">Aadhaar Card (Back)</label>
            <input
              type="file"
              id="aadhaar_back"
              name="aadhaar_back"
              required
              accept="image/*"
              class="form-file-input"
            />
          </div>
        </div>
        <div>
          <label for="craft_photos">Craft Photos (min 2, max 3)</label>
          <input
            type="file"
            id="craft_photos"
            name="craft_photos"
            required
            multiple
            accept="image/*"
            class="form-file-input"
          />
        </div>

        <button type="submit" id="submitBtn" class="submit-btn">
          Submit for Verification
        </button>

        <div id="message" class="message-box"></div>
      </form>
      <footer>
        <!-- <a href="admin.html">Admin Dashboard</a> -->
      </footer>
    </div>

    <script type="module">
      import { supabase } from "./supabase.js";

      const form = document.getElementById("artisanForm");
      const submitBtn = document.getElementById("submitBtn");
      const messageDiv = document.getElementById("message");
      // const craftPhotosInput = document.getElementById("craft_photos");

      // Simple client-side validation for file count
      // craftPhotosInput.addEventListener("change", () => {
      //   const files = craftPhotosInput.files;
      //   if (files.length < 2 || files.length > 3) {
      //     craftPhotosInput.setCustomValidity(
      //       "Please upload between 2 and 3 craft photos."
      //     );
      //   } else {
      //     craftPhotosInput.setCustomValidity("");
      //   }
      // });

      // function getEmbedUrl(url) {
      //   try {
      //     const ytRegex = /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/;
      //     const match = url.match(ytRegex);

      //     if (match && match[1]) {
      //       return `https://www.youtube.com/embed/${match[1]}`;
      //     }
      //     return url; // fallback if it's already embed or another provider
      //   } catch {
      //     return url;
      //   }
      // }

      // Helper function to upload a single file
      async function uploadFile(file, path) {
        const { data, error: uploadError } = await supabase.storage
          .from("artisan_files")
          .upload(path, file, { upsert: true });

        if (uploadError) throw uploadError;

        // Get a PUBLIC URL for the uploaded file
        const { data: publicData } = supabase.storage
          .from("artisan_files")
          .getPublicUrl(path);

        return publicData.publicUrl;
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        setLoading(true);

        try {
          // Get last artisan ID
          const { data: lastArtisan } = await supabase
            .from("artisans_public")
            .select("artisan_id")
            .order("artisan_id", { ascending: false })
            .limit(1)
            .single();

          let newId = "ART001";
          if (lastArtisan && lastArtisan.artisan_id) {
            const lastNum = parseInt(
              lastArtisan.artisan_id.replace("ART", ""),
              10
            );
            const nextNum = (lastNum + 1).toString().padStart(3, "0");
            newId = `ART${nextNum}`;
          }

          const formData = new FormData(form);

          // Map form fields
          const name = formData.get("name");
          const place = formData.get("location");
          const phone = formData.get("phone") || null;
          const craft = formData.get("craft") || null;
          const lineage = formData.get("lineage") || null;
          const awards = formData.get("awards") || null;
          const one_liner = formData.get("one_liner") || null;
          const quote = formData.get("quote") || null;
          const craft_process = formData.get("craft_process") || null;
          const gi_tag_info = formData.get("gi_tag_info") || null;
          const verification_notes = formData.get("verification_notes") || null;
          const business_identity = formData.get("business_identity") || null;

          const workshopFilesInput = document.getElementById(
            "workshop_photo_link"
          );
          const workshopFiles = workshopFilesInput.files; // FileList
          const uploadedWorkshopPhotos = [];

          for (const file of workshopFiles) {
            const galPhotoUrl = await uploadFile(
              file,
              `${newId}/workshop_${file.name}`
            );
            uploadedWorkshopPhotos.push(galPhotoUrl);
          }

          //Video
          function getEmbedUrl(url) {
            // YouTube
            const ytRegex = /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/;
            const ytMatch = url.match(ytRegex);
            if (ytMatch && ytMatch[1]) {
              return `https://www.youtube.com/embed/${ytMatch[1]}`;
            }

            // Vimeo
            const vimeoRegex = /vimeo\.com\/(\d+)/;
            const vimeoMatch = url.match(vimeoRegex);
            if (vimeoMatch && vimeoMatch[1]) {
              return `https://player.vimeo.com/video/${vimeoMatch[1]}`;
            }

            return url;
          }

          let video_link = formData.get("video_link") || null;
          if (video_link) {
            video_link = getEmbedUrl(video_link);
          }

          //For upload video from system
          // const uploadedVideoLinks = [];

          // for (const file of videoFiles) {
          //   const videoUrl = await uploadFile(
          //     file,
          //     `${newId}/videos${file.name}`
          //   );
          //   uploadedVideoLinks.push(videoUrl);
          // }

          // Handle photo upload
          let photoUrl = null;
          const photoFile = formData.get("photo_link");

          if (photoFile && photoFile.size > 0) {
            photoUrl = await uploadFile(
              photoFile,
              `${newId}/photo_${photoFile.name}`
            );
          }

          // Insert into DB/
          const { error: insertError } = await supabase
            .from("artisans_public")
            .insert([
              {
                artisan_id: newId,
                name,
                craft,
                place,
                lineage,
                awards,
                one_liner,
                quote,
                craft_process,
                gi_tag_info,
                verification_notes,
                photo_link: photoUrl,
                workshop_photo_link: uploadedWorkshopPhotos,
                video_link: video_link || null,
                business_identity: business_identity,
                phone,
              },
            ]);

          if (insertError) throw insertError;

          showMessage(
            "Submission successful! Your application is under review.",
            "success"
          );
          form.reset();
        } catch (err) {
          console.error("Submission Error:", err);
          showMessage(`Error: ${err.message}`, "error");
        } finally {
          setLoading(false);
        }
      });

      // Helper function
      // async function uploadFile(file, path) {
      //   const { error } = await supabase.storage
      //     .from("artisan_files")
      //     .upload(path, file, { upsert: true });

      //   if (error) throw error;

      //   const {
      //     data: { publicUrl },
      //   } = supabase.storage.from("artisan_files").getPublicUrl(path);

      //   return publicUrl;
      // }

      function setLoading(isLoading) {
        submitBtn.disabled = isLoading;
        submitBtn.textContent = isLoading
          ? "Submitting..."
          : "Submit for Verification";
      }

      function showMessage(msg, type = "success") {
        messageDiv.textContent = msg;
        // Reset classes and add new ones for styling the message box
        messageDiv.className = "message-box";
        messageDiv.classList.add("show", type); // 'type' will be 'success' or 'error'
      }
    </script>
  </body>
</html>
