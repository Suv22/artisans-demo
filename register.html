<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Artisan Verification Form</title>
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
      /* === Aesthetic White Theme === */

      /* --- CSS Variables (Theme) --- */
      :root {
        /* A clean, minimalist light palette */
        --background: 210 40% 98%; /* Soft, cool off-white background */
        --foreground: 220 15% 20%; /* Dark charcoal for text */
        --card: 0 0% 100%; /* Pure white for cards */
        --primary: 220 15% 20%; /* Dark charcoal as the primary accent */
        --primary-foreground: 0 0% 100%; /* White text for buttons */
        --muted-foreground: 220 10% 45%; /* Medium gray for secondary text */
        --border: 214 32% 91%; /* Light, subtle border */
        --input: 214 32% 91%;
        --ring: 220 15% 30%; /* A slightly lighter charcoal for focus rings */
        --radius: 0.5rem;
      }

      /* --- Basic Reset and Body Styles --- */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body,
      html {
        font-family: "Inter", sans-serif;
        color: #333;
        background-color: #fdfdfd;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
       .container {
        max-width: 50rem; /* 672px */
        }
      .page-container {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        padding: 1.5rem; /* Mobile padding */
        box-sizing: border-box;
      }

      .main-header {
        display: flex;
        justify-content: flex-end; /* Align hamburger to the right */
        align-items: center;
        width: 100%;
      }

      .desktop-nav {
        display: none; /* Hide desktop nav on mobile */
      }

       /* Hamburger Menu */
      .hamburger-menu {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        width: 2rem;
        height: 1.5rem;
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0;
        z-index: 10;
      }

      .hamburger-bar {
        width: 1.7rem;
        height: 0.1rem;
        background: #333;
        border-radius: 10px;
        transition: all 0.3s linear;
      }

      /* Mobile Navigation Panel */
       .mobile-nav {
          display: flex;
          flex-direction: column;
          justify-content: start;
          align-items: start;
          background: #fdfdfd;
          height: 100vh;
          width: 100%;
          position: fixed;
          top: 0;
          left: 0;
          transform: translateX(100%);
          transition: transform 0.3s ease-in-out;
          z-index: 5;
        }

        .mobile-nav.is-open {
          transform: translateX(0);
        }

        .mobile-nav nav {
          margin-top: 2rem;
          margin-left: 2rem;
          display: flex;
          flex-direction: column;
          text-align: center;
          
        }

        .mobile-nav a {
          font-size: 14.4px;
          padding: 0.4rem;
          color: #333;
          text-decoration: none;
          text-align: left;
          font-weight: 500;
        }

      /* --- Layout Styles --- */
      .container {
        max-width: 50rem; /* 672px */
        margin: 0 auto;
        padding: 1.5rem 1rem;
      }

      .heading-section {
        text-align: center;
        margin-bottom: 2.5rem;
      }

      .heading-section h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #333; /* Use main text color for the title */
      }

      .heading-section p {
        color: hsl(var(--muted-foreground));
        margin-top: 0.5rem;
        font-size: 0.8rem;
      }

      /* --- Form Styles --- */
      .artisan-form {
        background-color: hsl(var(--card));
        padding: 1.5rem;
        border-radius: var(--radius);
        border: 1px solid hsl(var(--border));
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05),
          0 2px 4px -2px rgba(0, 0, 0, 0.05);
      }

      /* Adds vertical space between direct children of the form */
      .artisan-form > * + * {
        margin-top: 1.5rem;
      }

      /* --- Form Element Styles --- */
      label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #555;
      }

      .form-input {
        width: 100%;
        padding: 0.75rem;
        background-color: hsl(var(--background));
        border: 1px solid hsl(var(--input));
        border-radius: calc(50px);
        font-size: 1rem;
        color: hsl(var(--foreground));
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: hsl(var(--ring));
        box-shadow: 0 0 0 2px hsla(var(--ring), 0.5);
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .form-file-input {
        width: 100%;
        font-size: 0.875rem;
        color: hsl(var(--muted-foreground));
      }

      .form-file-input::file-selector-button {
        background-color: transparent;
        border: 1px solid #ccc;
        border-radius: 50px;
        padding: 0.8rem 1.5rem;
        font-size: 0.9rem;
        font-family: "Inter", sans-serif;
        cursor: pointer;
        color: #555;
        transition: all 0.3s ease;
      }

      .form-file-input::file-selector-button:hover {
        background-color: #f5f5f5;
        border-color: #999;
      }
      .button-wrapper {
        text-align: center;
      }

      .submit-btn {
        background-color: transparent;
        border: 1px solid #ccc;
        border-radius: 50px;
        padding: 0.8rem 1.5rem;
        font-size: 0.9rem;
        font-family: "Inter", sans-serif;
        cursor: pointer;
        color: #555;
        transition: all 0.3s ease;
      }

      .submit-btn:hover {
        background-color: #f5f5f5;
        border-color: #999;
      }

      .submit-btn:focus {
        outline: none;
        box-shadow: 0 0 0 2px hsl(var(--background)), 0 0 0 4px hsl(var(--ring));
      }

      .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* --- Message Box & Footer --- */
      .message-box {
        text-align: center;
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: calc(var(--radius) - 2px);
        display: none; /* Initially hidden */
      }
      .message-box.show {
        display: block;
      }
      .message-box.success {
        background-color: #d1fae5; /* A light green */
        color: #065f46; /* A dark green */
      }
      .message-box.error {
        background-color: #fee2e2; /* A light red */
        color: #991b1b; /* A dark red */
      }
      
      .top-right-link {
        /* This is the key part for positioning */
        position: fixed;
        bottom: 20px; /* 20px from the top */
        right: 20px; /* 20px from the right */

        /* The z-index ensures it's on top of other content */
        z-index: 1000;

        /* --- Optional styling to make it look nice --- */
        padding: 0.6rem 1rem;
        background-color: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
        text-decoration: none;
        font-family: sans-serif;
        font-size: 0.9rem;
        border-radius: 5px;
        transition: background-color 0.2s ease-in-out;
      }

      .top-right-link:hover {
        background-color: #555;
      }
      
      @media (max-width: 480px) {
        .artisan-grid {
          grid-template-columns: repeat(2, 1fr); /* still 2 cols on phones */
          gap: 0.8rem;
        }
        .artisan-card img {
          height: 140px; /* smaller images */
        }
        .artisan-card .artisan-name {
          font-size: 0.9rem;
        }
      }

      /* Footer */
      .main-footer {
        display: flex;
        flex-direction: column; /* Stack items vertically */
        gap: 1rem;
        text-align: center;
        width: 100%;
        padding-top: 2rem;
        font-size: 0.8rem;
        color: #666;
      }

      .footer-right {
        display: flex;
        flex-wrap: wrap; /* Allow links to wrap */
        justify-content: center;
        gap: 1rem;
      }

      .footer-right a {
        text-decoration: none;
        color: #666;
      }

      /* --- desktop Responsive Styles --- */
      @media (min-width: 768px) {
        .container {
          width: 60%;
        }

        .page-container {
          padding: 2rem 4rem; /* Desktop padding */
        }

        .main-header {
          justify-content: space-between;
        }

        .desktop-nav {
          display: flex;
          justify-content: space-between;
          width: 100%;
        }

        .nav-left,
        .nav-right {
          display: flex;
          gap: 1.5rem;
          align-items: center;
        }

        .desktop-nav a {
          text-decoration: none;
          color: #333;
          font-size: 0.9rem;
        }

        .hamburger-menu {
          display: none; /* Hide hamburger on desktop */
        }

        .cta-button {
          padding: 1rem 2rem;
          font-size: 1rem;
        }

        .main-footer {
          flex-direction: row; /* Align side-by-side */
          justify-content: space-between;
        }

        .footer-right a {
          margin-left: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- <a href="admin.html" class="top-right-link">Admin Dashboard</a> -->
    <div class="page-container">
      <header class="main-header">
        <div class="desktop-nav">
          <nav class="nav-left">
            <a href="all_craftsList.html">Crafts</a>
            <a href="verificatn.html">Verification Standards</a>
            <a href="index.html">Home</a>
          </nav>
          <nav class="nav-right">
            <!-- <a href="register.html">Register Artisan</a> -->
            <a href="our_jrny.html">Our Journey</a>
            <a href="register.html">Get Verified</a>
          </nav>
        </div>

        <button
          class="hamburger-menu"
          id="hamburger-menu"
          aria-label="Open navigation menu"
        >
          <span class="hamburger-bar"></span>
          <span class="hamburger-bar"></span>
          <span class="hamburger-bar"></span>
        </button>
      </header>
       <div class="mobile-nav" id="mobile-nav">
        <nav>
          <!-- <a href="register.html">Register Artisan</a> -->
          <a href="all_craftsList.html">Crafts</a>
          <!-- <a href="#">Artisan Stories</a> -->
          <a href="verificatn.html">Verification Standards</a>
          <a href="our_jrny.html">Our Journey</a>
          <a href="register.html">Get Verified</a>
          <a href="index.html">Home</a>
        </nav>
      </div>
      <div class="container">
        <div class="heading-section">
          <h1>Artisan Verification</h1>
          <p>Submit your details and craft for verification.</p>
        </div>

        <form id="artisanForm" class="artisan-form">
          <div>
            <label for="name">Full Name</label>
            <input
              type="text"
              id="name"
              name="name"
              required
              class="form-input"
            />
          </div>
          <div>
            <label for="phone">Phone Number</label>
            <input
              type="tel"
              id="phone"
              name="phone"
              required
              class="form-input"
            />
          </div>
          <!-- <div>
          <label for="craft">Craft</label>
          <select id="craft" name="craft_id" class="form-input" required>
            <option value="">-- Select Craft --</option>
            <option value="1">Pottery</option>
            <option value="2">Weaving</option>
            <option value="3">Woodwork</option>
            <option value="4">Painting</option>
            <option value="5">Jewelry</option>
          </select>
        </div> -->
          <div>
            <label for="craft">Craft</label>
            <select id="craft" name="craft_id" class="form-input" required>
              <option value="">-- Select Craft --</option>
            </select>
          </div>

          <div>
            <label for="experience">Years of Experience</label>
            <input
              type="number"
              id="experience"
              name="experience"
              class="form-input"
              placeholder="e.g., 5"
              min="0"
            />
          </div>
          <div>
            <label for="materials">Materials Used</label>
            <input
              type="text"
              id="materials"
              name="materials"
              placeholder="e.g., Clay, Natural dyes, Cotton threads, Brass, Wood"
              class="form-input"
              required
            />
          </div>

          <div>
            <label for="awards">Awards</label>
            <select id="awards" name="awards" class="form-input" multiple>
              <option value="">-- Select Award --</option>
              <option value="State Award">State Award</option>
              <option value="National Award">National Award</option>
              <option value="National Merit Certificate">
                National Merit Certificate
              </option>
              <option value="Hastakala Award">Hastakala Award</option>
              <option value="Shilp Guru Award">Shilp Guru Award</option>
              <option value="GI Product">GI Product</option>
            </select>
          </div>
          <div>
            <label for="lineage">Lineage</label>
            <textarea
              id="lineage"
              name="lineage"
              placeholder="Lineage Info"
              class="form-input"
            ></textarea>
          </div>


          <div>
            <label for="one_liner">One Liner</label>
            <input
              type="text"
              id="one_liner"
              name="one_liner"
              placeholder="A short tagline about the artisan"
              class="form-input"
            />
          </div>
          <div>
            <label for="quote">Quote</label>
            <input
              type="text"
              id="quote"
              name="quote"
              placeholder="Inspiring quote by the artisan"
              class="form-input"
            />
          </div>

          <!-- GI Tag Info -->
          <div>
            <label for="g_tag_info">GI Tag Info</label>
            <input
              type="text"
              id="g_tag_info"
              name="gi_tag_info"
              placeholder="GI Tag details if applicable"
              class="form-input"
            />
          </div>

          <!-- Verification Notes (optional, admin use) -->
          <div>
            <label for="verification_notes">Verification Notes</label>
            <textarea
              id="verification_notes"
              name="verification_notes"
              placeholder="Admin verification notes"
              class="form-input"
            ></textarea>
          </div>

          <!-- Photo Link -->
          <div>
            <label for="photo_link">Upload Artisan Photo</label>
            <input
              type="file"
              id="photo_link"
              name="photo_link"
              accept="image/*"
              class="form-file-input"
            />
          </div>

          <!-- Workshop Photo Link -->
          <div>
            <label for="workshop_photo_link">Workshop Photo Link</label>
            <input
              type="file"
              id="workshop_photo_link"
              name="workshop_photo_link"
              accept="image/*"
              class="form-file-input"
              multiple
            />
          </div>

          <!-- Video Link -->
          <!-- <div>
          <label for="video_link">Video Link</label>
          <input
            type="url"
            id="video_link"
            name="video_link"
            placeholder="Paste YouTube or Vimeo link"
            class="form-input"
          />
        </div> -->

          <!-- Business Identity -->
          <div>
            <label for="business_identity"
              >Business Identity (Established Year)</label
            >
            <input
              type="text"
              id="business_identity"
              name="business_identity"
              placeholder="Business identity details"
              class="form-input"
            />
          </div>

          <div>
            <label for="aadhaar_last4">Last 4 Digits of Aadhaar</label>
            <input
              type="text"
              id="aadhaar_last4"
              name="aadhaar_last4"
              required
              minlength="4"
              maxlength="4"
              pattern="\d{4}"
              class="form-input"
            />
          </div>
          <div>
            <label for="location">Location (City, State)</label>
            <input
              type="text"
              id="location"
              name="location"
              required
              class="form-input"
            />
          </div>

          <div class="form-grid">
            <div>
              <label for="aadhaar_front">Aadhaar Card (Front)</label>
              <input
                type="file"
                id="aadhaar_front"
                name="aadhaar_front"
                accept="image/*"
                class="form-file-input"
              />
            </div>
            <div>
              <label for="aadhaar_back">Aadhaar Card (Back)</label>
              <input
                type="file"
                id="aadhaar_back"
                name="aadhaar_back"
                accept="image/*"
                class="form-file-input"
              />
            </div>
          </div>
          <!-- <div>
          <label for="craft_photos">Craft Photos (min 2, max 3)</label>
          <input
            type="file"
            id="craft_photos"
            name="craft_photos"
            required
            multiple
            accept="image/*"
            class="form-file-input"
          />
        </div> -->

          <div class="button-wrapper">
            <button type="submit" id="submitBtn" class="submit-btn">
              Submit for Verification
            </button>
          </div>

          <div id="message" class="message-box"></div>
        </form>
      </div>
      <footer class="main-footer">
        <div class="footer-left">
          &copy; GI Connect &middot; 2025 Authorship. Craft. Trust.
        </div>
        <div class="footer-right">
          <a href="#">Contact us</a>
          <a href="termsOfUse.html">Terms</a>
          <a href="privacy_policy.html">Privacy</a>
          <a href="accessibility.html">Accessibility</a>
          <a href="log_in.html">Admin Dashboard</a>
        </div>
      </footer>
    </div>

    <script type="module">
      import { supabase } from "./supabaseClient.js";

      const form = document.getElementById("artisanForm");
      const submitBtn = document.getElementById("submitBtn");
      const messageDiv = document.getElementById("message");
      let craftsList = [];

      async function loadCrafts() {
        const { data: crafts, error } = await supabase
          .from("crafts")
          .select("id, name")
          .order("name", { ascending: true });

        console.log("Crafts fetched:", crafts, "Error:", error); // <<<< add this

        if (error) {
          console.error("Error fetching crafts:", error);
          return;
        }
        craftsList = crafts; // Store globally if needed elsewhere

        const select = document.getElementById("craft");
        crafts.forEach((craft) => {
          const option = document.createElement("option");
          option.value = craft.id;
          option.textContent = craft.name;
          select.appendChild(option);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        const hamburgerMenu = document.getElementById("hamburger-menu");
        const mobileNav = document.getElementById("mobile-nav");

        hamburgerMenu.addEventListener("click", () => {
          // Toggle the 'is-open' class on the mobile navigation menu
          mobileNav.classList.toggle("is-open");
        });
      });

      document.addEventListener("DOMContentLoaded", loadCrafts);

      $(document).ready(function () {
        $("#awards").select2({
          placeholder: "-- Select Awards --",
          closeOnSelect: false,
        });
      });
      // Helper function to upload a single file
      async function uploadFile(file, path) {
        const { data, error: uploadError } = await supabase.storage
          .from("artisan_files")
          .upload(path, file, { upsert: true });

        if (uploadError) throw uploadError;

        // Get a PUBLIC URL for the uploaded file
        const { data: publicData } = supabase.storage
          .from("artisan_files")
          .getPublicUrl(path);

        return publicData.publicUrl;
      }
      function getCraftNameById(id) {
        const craft = craftsList.find((c) => c.id === id);
        return craft ? craft.name : null;
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        setLoading(true);

        try {
          // --- STEP 1: Collect Form Data ---
          const formData = new FormData(form);

          const name = formData.get("name")?.trim();
          const place = formData.get("location")?.trim();
          const phone = formData.get("phone")?.trim();
          // const craft = formData.get("craft")?.trim();
          const craft_id = formData.get("craft_id");
          const craft_name = getCraftNameById(craft_id);
          console.log("Selected craft ID:", craft_id);
          const experience = formData.get("experience")?.trim();
          const materials = formData.get("materials")?.trim();
          const lineage = formData.get("lineage")?.trim();
          const awards = formData.getAll("awards");
          const one_liner = formData.get("one_liner")?.trim();
          const quote = formData.get("quote")?.trim();
          // const craft_process = formData.get("craft_process")?.trim();
          const gi_tag_info = formData.get("gi_tag_info")?.trim();
          const verification_notes = formData.get("verification_notes")?.trim();
          const business_identity = formData.get("business_identity")?.trim();

          // --- STEP 2: Validate required fields ---
          if (!name || !place || !craft) {
            showMessage("Please fill all mandatory fields..", "error");
            setLoading(false);
            return;
          }

          if (phone && !/^\d{10}$/.test(phone)) {
            showMessage("Please enter a valid 10-digit phone number.", "error");
            setLoading(false);
            return;
          }

          // --- STEP 3: Get Last Artisan ID ---
          const { data: lastArtisan } = await supabase
            .from("artisans_public")
            .select("artisan_id")
            .order("artisan_id", { ascending: false })
            .limit(1)
            .single();

          let newId = "ART001";
          if (lastArtisan && lastArtisan.artisan_id) {
            const lastNum = parseInt(
              lastArtisan.artisan_id.replace("ART", ""),
              10
            );
            const nextNum = (lastNum + 1).toString().padStart(3, "0");
            newId = `ART${nextNum}`;
          }

          // --- STEP 4: Only Now Upload Files ---
          const workshopFilesInput = document.getElementById(
            "workshop_photo_link"
          );
          const workshopFiles = workshopFilesInput.files;
          const uploadedWorkshopPhotos = [];

          for (const file of workshopFiles) {
            const galPhotoUrl = await uploadFile(
              file,
              `${newId}/workshop_${file.name}`
            );
            uploadedWorkshopPhotos.push(galPhotoUrl);
          }

          // --- STEP 5: Process Video URL ---
          function getEmbedUrl(url) {
            const ytRegex = /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/;
            const vimeoRegex = /vimeo\.com\/(\d+)/;
            const ytMatch = url.match(ytRegex);
            const vimeoMatch = url.match(vimeoRegex);
            if (ytMatch && ytMatch[1])
              return `https://www.youtube.com/embed/${ytMatch[1]}`;
            if (vimeoMatch && vimeoMatch[1])
              return `https://player.vimeo.com/video/${vimeoMatch[1]}`;
            return url;
          }

          let video_link = formData.get("video_link")?.trim() || null;
          if (video_link) video_link = getEmbedUrl(video_link);

          // --- STEP 6: Upload Profile Photo ---
          let photoUrl = null;
          const photoFile = formData.get("photo_link");
          if (photoFile && photoFile.size > 0) {
            photoUrl = await uploadFile(
              photoFile,
              `${newId}/photo_${photoFile.name}`
            );
          }

          // --- STEP 7: Insert into Database ---
          const { error: insertError } = await supabase
            .from("artisans_public")
            .insert([
              {
                artisan_id: newId,
                name,
                craft: craft_name,
                craft_id: craft_id,
                yr_experience: experience,
                materials,
                place,
                lineage,
                awards: awards.join(", "),
                one_liner,
                quote,
                // craft_process,
                gi_tag_info,
                verification_notes,
                photo_link: photoUrl,
                workshop_photo_link: uploadedWorkshopPhotos,
                video_link,
                business_identity,
                phone,
              },
            ]);

          if (insertError) throw insertError;

          showMessage(
            "Submission successful! Your application is under review.",
            "success"
          );
          form.reset();
        } catch (err) {
          console.error("Submission Error:", err);
          showMessage(`Error: ${err.message}`, "error");
        } finally {
          setLoading(false);
        }
      });

      // Helper function
      // async function uploadFile(file, path) {
      //   const { error } = await supabase.storage
      //     .from("artisan_files")
      //     .upload(path, file, { upsert: true });

      //   if (error) throw error;

      //   const {
      //     data: { publicUrl },
      //   } = supabase.storage.from("artisan_files").getPublicUrl(path);

      //   return publicUrl;
      // }

      function setLoading(isLoading) {
        submitBtn.disabled = isLoading;
        submitBtn.textContent = isLoading
          ? "Submitting..."
          : "Submit for Verification";
      }

      function showMessage(msg, type = "success") {
        messageDiv.textContent = msg;
        // Reset classes and add new ones for styling the message box
        messageDiv.className = "message-box";
        messageDiv.classList.add("show", type); // 'type' will be 'success' or 'error'
      }
    </script>
  </body>
</html>
